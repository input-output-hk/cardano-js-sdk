name: Continuous Integration - E2E

env:
  TL_DEPTH: ${{ github.event.pull_request.head.repo.fork && '0' || fromJson(vars.TL_DEPTH) }}
  TL_LEVEL: ${{ github.event.pull_request.head.repo.fork && 'info' || vars.TL_LEVEL }}

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "master" ]
    tags: [ "*.*.*" ]

jobs:
  build_and_test_wallet:
    strategy:
      matrix:
        os: [ ubuntu-20.04 ]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v3

    - name: 游빓 Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.12.0

    - name: 游댣 Build
      run: |
        yarn install --immutable --inline-builds
        yarn build
        docker build --no-cache .

    - name: 游깷 Setup local test network
      working-directory: packages/e2e
      run: |
        yarn local-network:up -d
      env:
        CARDANO_NODE_CHAINDB_LOG_LEVEL: 'Warning'
        CARDANO_NODE_LOG_LEVEL: 'Warning'
        OGMIOS_PORT: '1340'
        OGMIOS_URL: 'ws://cardano-node-ogmios:1340'
        POSTGRES_PORT: '5435'

    - name: Dump docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@v2

    - name: Wait for some epochs
      run: |
        yarn workspace @cardano-sdk/e2e wait-for-network
      env:
        DB_SYNC_CONNECTION_STRING: 'postgresql://postgres:doNoUseThisSecret!@localhost:5435/cexplorer'

    - name: 游댧 Test - e2e - wallet
      run: |
        source .github/workflow/continuous-integration-e2e.env
        yarn workspace @cardano-sdk/e2e test:wallet

  build_and_test_providers:
    strategy:
      matrix:
        os: [ ubuntu-20.04 ]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v3

    - name: 游빓 Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.12.0

    - name: 游댣 Build
      run: |
        yarn install --immutable --inline-builds
        yarn build
        docker build --no-cache .

    - name: 游깷 Setup local test network
      working-directory: packages/e2e
      run: |
        yarn local-network:up -d
      env:
        CARDANO_NODE_CHAINDB_LOG_LEVEL: 'Warning'
        CARDANO_NODE_LOG_LEVEL: 'Warning'
        OGMIOS_PORT: '1340'
        OGMIOS_URL: 'ws://cardano-node-ogmios:1340'
        POSTGRES_PORT: '5435'

    - name: Dump docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@v2

    - name: Wait for some epochs
      run: |
        yarn workspace @cardano-sdk/e2e wait-for-network
      env:
        DB_SYNC_CONNECTION_STRING: 'postgresql://postgres:doNoUseThisSecret!@localhost:5435/cexplorer'

    - name: 游댧 Test - e2e - wallet
      run: |
        source .github/workflow/continuous-integration-e2e.env
        yarn workspace @cardano-sdk/e2e test:providers

  build_and_test_projection:
    strategy:
      matrix:
        os: [ ubuntu-20.04 ]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v3

    - name: 游빓 Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.12.0

    - name: 游댣 Build
      run: |
        yarn install --immutable --inline-builds
        yarn build
        docker build --no-cache .

    - name: 游깷 Setup local test network
      working-directory: packages/e2e
      run: |
        yarn local-network:up -d
      env:
        CARDANO_NODE_CHAINDB_LOG_LEVEL: 'Warning'
        CARDANO_NODE_LOG_LEVEL: 'Warning'
        OGMIOS_PORT: '1340'
        OGMIOS_URL: 'ws://cardano-node-ogmios:1340'
        POSTGRES_PORT: '5435'

    - name: Dump docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@v2

    - name: Wait for some epochs
      run: |
        yarn workspace @cardano-sdk/e2e wait-for-network
      env:
        DB_SYNC_CONNECTION_STRING: 'postgresql://postgres:doNoUseThisSecret!@localhost:5435/cexplorer'

    - name: 游댧 Test - e2e - wallet
      run: |
        source .github/workflow/continuous-integration-e2e.env
        yarn workspace @cardano-sdk/e2e test:projection


  build_and_test_pg_boss:
    strategy:
      matrix:
        os: [ ubuntu-20.04 ]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 游닌 Checkout repository
      uses: actions/checkout@v3

    - name: 游빓 Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.12.0

    - name: 游댣 Build
      run: |
        yarn install --immutable --inline-builds
        yarn build
        docker build --no-cache .

    - name: 游깷 Setup local test network
      working-directory: packages/e2e
      run: |
        yarn local-network:up -d
      env:
        CARDANO_NODE_CHAINDB_LOG_LEVEL: 'Warning'
        CARDANO_NODE_LOG_LEVEL: 'Warning'
        OGMIOS_PORT: '1340'
        OGMIOS_URL: 'ws://cardano-node-ogmios:1340'
        POSTGRES_PORT: '5435'

    - name: Dump docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@v2

    - name: Wait for some epochs
      run: |
        yarn workspace @cardano-sdk/e2e wait-for-network
      env:
        DB_SYNC_CONNECTION_STRING: 'postgresql://postgres:doNoUseThisSecret!@localhost:5435/cexplorer'

    - name: 游댧 Test - e2e - wallet
      run: |
        source .github/workflow/continuous-integration-e2e.env
        yarn workspace @cardano-sdk/e2e test:pg-boss
