version: '3.9'

x-logging: &logging
  logging:
    driver: 'json-file'
    options:
      max-size: '400k'
      max-file: '20'

services:
  postgres:
    volumes:
      - postgres-data:/var/lib/postgresql/data

  cardano-node-ogmios:
    image: cardanosolutions/cardano-node-ogmios:v${OGMIOS_VERSION:-5.6.0}_${CARDANO_NODE_VERSION:-1.35.5}-${NETWORK:-mainnet}
    volumes:
      - ./config/network/${NETWORK:-mainnet}:/config

  cardano-db-sync:
    volumes:
      - ./config/network/${NETWORK:-mainnet}:/config

  blockfrost-worker:
    <<: *logging
    build:
      context: ../../
      target: blockfrost-worker
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - CACHE_TTL=${CACHE_TTL:-1440}
      - CREATE_SCHEMA=${CREATE_SCHEMA:-true}
      - DROP_SCHEMA=${DROP_SCHEMA:-false}
      - LOGGER_MIN_SEVERITY=${LOGGER_MIN_SEVERITY:-info}
      - NETWORK=${NETWORK:-mainnet}
      - SCAN_INTERVAL=${SCAN_INTERVAL:-60}
    ports:
      - ${API_PORT:-4001}:3000
    restart: on-failure
    secrets:
      - blockfrost_key
      - postgres_db
      - postgres_password
      - postgres_user

secrets:
  blockfrost_key:
    file: ./blockfrost-keys/${NETWORK:-mainnet}.key
  postgres_db:
    file: ./placeholder-secrets/postgres_db
  postgres_password:
    file: ./placeholder-secrets/postgres_password
  postgres_user:
    file: ./placeholder-secrets/postgres_user

volumes:
  postgres-data:
