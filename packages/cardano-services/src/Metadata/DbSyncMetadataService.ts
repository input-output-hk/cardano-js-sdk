import * as Queries from './queries';
import { Cardano } from '@cardano-sdk/core';
import { Logger } from 'ts-log';
import { Pool, QueryResult } from 'pg';
import { TxMetadataModel, TxMetadataService } from './types';
import { hexStringToBuffer } from '@cardano-sdk/util';
import { mapTxMetadataByHashes } from './util';

export type TxMetadataByHashes = Map<Cardano.TransactionId, Cardano.TxMetadata>;

export const createDbSyncMetadataService = (db: Pool, logger: Logger): TxMetadataService => ({
  async queryTxMetadataByHashes(hashes: Cardano.TransactionId[]): Promise<TxMetadataByHashes> {
    const byteHashes = hashes.map((hash) => hexStringToBuffer(hash));
    logger.debug('About to find metadata for txs:', hashes);

    const { rows } = await db.query<TxMetadataModel>({
      name: 'tx_metadata',
      text: Queries.findTxMetadataByTxHashes,
      values: [byteHashes]
    });

    logger.debug('Got metadata', rows);

    return rows.length === 0 ? new Map() : mapTxMetadataByHashes(rows);
  },

  async queryTxMetadataByRecordIds(ids: string[]): Promise<TxMetadataByHashes> {
    logger.debug('About to find metadata for transactions with ids:', ids);

    const result: QueryResult<TxMetadataModel> = await db.query({
      name: 'tx_metadata_by_tx_ids',
      text: Queries.findTxMetadataByTxIds,
      values: [ids]
    });

    if (result.rows.length === 0) return new Map();
    return mapTxMetadataByHashes(result.rows);
  }
});

/*

curl 'http://localhost:4000/v1.0.0/asset/get-assets' \
  -H 'authority: backend.dev-perf-mainnet.eks.lw.iog.io' \
  -H 'accept: application/json, text/plain' \
  -H 'accept-language: en-GB,en-US;q=0.9,en;q=0.8' \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -H 'origin: chrome-extension://gafhhkghbfjjkeiendhlofajokpaflmk' \
  -H 'pragma: no-cache' \
  -H 'sec-fetch-dest: empty' \
  -H 'sec-fetch-mode: cors' \
  -H 'sec-fetch-site: none' \
  -H 'sec-gpc: 1' \
  -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36' \
  -H 'version-api: "1.0.0"' \
  -H 'version-software: 0.16.4' \
  --data-raw '{"assetIds":["5817c34e5702473304f3cf676299176d3824e55b8c0bfa94830429fd018cc251f400","f94fd008635cf307663aadd995ed69d5fbbfd65f84679fc38254d664018cc251f400","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093fcca1607ab60abcbae3d93f6d8e72ba70e7506803e74f25e6936944ac1e1143cc","a0028f350aaabe0545fdcb56b039bfb08e4bb4d8c4d7c3c7d481c235484f534b59","de9b756719341e79785aa13c164e7fe68c189ed04d61c9876b2fe53f4d7565736c69537761705f414d4d","0029cb7c88c7567b63d1a512c0ed626aa169688ec980730c0473b913702008","9a9693a9a37912a5097918f97918d15240c92ab729a0b7c4aa144d7753554e444145","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220d50a","8f9c32977d2bacb87836b64f7811e99734c6368373958da20172afba4d5949454c44","b6a7467ea1deb012808ef4e87b5ff371e85f7142d7b356a40d9b42a0436f726e75636f70696173205b76696120436861696e506f72742e696f5d","8db269c3ec630e06ae29f74bc39edd1f87c819f1056206e879a1cd61446a65644d6963726f555344","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f84368617261637465723132","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f84368726973746d617347726f7570506963313836","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f8536e6f77666c616b65313038","2e81d2fda1511fa7e427fa7692e1e52f7fc9c72b2fd180b9981d79ab497a6561436f6d654a6f696e41414441","86abe45be4d8fb2e8f28e8047d17d0ba5592f2a6c8c452fc88c2c14358524159","aa77a5b8f5e11a3bc51ca7992db15cc35870428eaf61fd85a4a0e055496e737472756d656e74616c4f4b3531","af2e27f580f7f08e93190a81f72462f153026d06450924726645891b44524950","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e4654","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294249534f4e","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220db0a","026a18d04a0c642759bb3d83b12e3344894e5c1c7b2aeb1a2113a5704c","026a18d04a0c642759bb3d83b12e3344894e5c1c7b2aeb1a2113a570a449f98fa06fff1d6c17b95c65ca609660049dc683cc3e94d3846b05419fc20d","13e9940c94572eafef8b391b64b4a2e898b6a7008ece9064631e6fd258","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f30","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f31","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f32","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f33","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f34","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f30","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f39","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f31","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f32","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f33","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f34","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465430","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465432","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465433","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465434","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465435","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542330","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542336","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542337","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542338","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542339","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e4654233130","0029cb7c88c7567b63d1a512c0ed626aa169688ec980730c0473b91370206003","38ad9dc3aec6a2f38e220142b9aa6ade63ebe71f65e7cc2b7d8a8535434c4159","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220df0a","279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3f534e454b","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093f0de488cdbd03990f316b5b9746e86595e57dfe1b3dd85a74291e0c04fdafbf6e","f66d78b4a3cb3d37afa0ec36461e51ecbde00f26c8f0a68f94b6988069555344","7c05046c325f03e0c995c0bd256dcb5516d1edd567b83d19eb35f725018cc251f400","8db269c3ec630e06ae29f74bc39edd1f87c819f1056206e879a1cd615368656e4d6963726f555344","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093fd2c8d7d47fb4046c68567e0f29bf0dce4e0a083cf4ce522ed741127dafa2ac59","f33bf12af1c23d660e29ebb0d3206b0bfc56ffd87ffafe2d36c42a454d7565736c69537761705f634c50"],"extraData":{"nftMetadata":true,"tokenMetadata":true}}' \
  --compressed


curl 'https://backend.dev-perf-mainnet.eks.lw.iog.io/v1.0.0/asset/get-assets' \
  -H 'authority: backend.dev-perf-mainnet.eks.lw.iog.io' \
  -H 'accept: application/json, text/plain' \
  -H 'accept-language: en-GB,en-US;q=0.9,en;q=0.8' \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -H 'origin: chrome-extension://gafhhkghbfjjkeiendhlofajokpaflmk' \
  -H 'pragma: no-cache' \
  -H 'sec-fetch-dest: empty' \
  -H 'sec-fetch-mode: cors' \
  -H 'sec-fetch-site: none' \
  -H 'sec-gpc: 1' \
  -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36' \
  -H 'version-api: "1.0.0"' \
  -H 'version-software: 0.16.4' \
  --data-raw '{"assetIds":["5817c34e5702473304f3cf676299176d3824e55b8c0bfa94830429fd018cc251f400","f94fd008635cf307663aadd995ed69d5fbbfd65f84679fc38254d664018cc251f400","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093fcca1607ab60abcbae3d93f6d8e72ba70e7506803e74f25e6936944ac1e1143cc","a0028f350aaabe0545fdcb56b039bfb08e4bb4d8c4d7c3c7d481c235484f534b59","de9b756719341e79785aa13c164e7fe68c189ed04d61c9876b2fe53f4d7565736c69537761705f414d4d","0029cb7c88c7567b63d1a512c0ed626aa169688ec980730c0473b913702008","9a9693a9a37912a5097918f97918d15240c92ab729a0b7c4aa144d7753554e444145","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220d50a","8f9c32977d2bacb87836b64f7811e99734c6368373958da20172afba4d5949454c44","b6a7467ea1deb012808ef4e87b5ff371e85f7142d7b356a40d9b42a0436f726e75636f70696173205b76696120436861696e506f72742e696f5d","8db269c3ec630e06ae29f74bc39edd1f87c819f1056206e879a1cd61446a65644d6963726f555344","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f84368617261637465723132","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f84368726973746d617347726f7570506963313836","5a0176dc400c08f397a041c2eaa0de667f13f117d3be204595ae77f8536e6f77666c616b65313038","2e81d2fda1511fa7e427fa7692e1e52f7fc9c72b2fd180b9981d79ab497a6561436f6d654a6f696e41414441","86abe45be4d8fb2e8f28e8047d17d0ba5592f2a6c8c452fc88c2c14358524159","aa77a5b8f5e11a3bc51ca7992db15cc35870428eaf61fd85a4a0e055496e737472756d656e74616c4f4b3531","af2e27f580f7f08e93190a81f72462f153026d06450924726645891b44524950","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e4654","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294249534f4e","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220db0a","026a18d04a0c642759bb3d83b12e3344894e5c1c7b2aeb1a2113a5704c","026a18d04a0c642759bb3d83b12e3344894e5c1c7b2aeb1a2113a570a449f98fa06fff1d6c17b95c65ca609660049dc683cc3e94d3846b05419fc20d","13e9940c94572eafef8b391b64b4a2e898b6a7008ece9064631e6fd258","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f30","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f31","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f32","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f33","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294962696c65636f696e5f34","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f30","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f39","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f31","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f32","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f33","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294269736f6e20436f696e5f34","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465430","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465432","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465433","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465434","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e465435","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542330","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542336","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542337","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542338","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e46542339","63f01fe6cd68ec6438c95a46cea4a6cd27efb791b5e8cc1fa92af3294c6163654e4654233130","0029cb7c88c7567b63d1a512c0ed626aa169688ec980730c0473b91370206003","38ad9dc3aec6a2f38e220142b9aa6ade63ebe71f65e7cc2b7d8a8535434c4159","e8a447d4e19016ca2aa74d20b4c4de87adb1f21dfb5493bf2d7281a673636f6f70657220df0a","279c909f348e533da5808898f87f9a14bb2c3dfbbacccd631d927a3f534e454b","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093f0de488cdbd03990f316b5b9746e86595e57dfe1b3dd85a74291e0c04fdafbf6e","f66d78b4a3cb3d37afa0ec36461e51ecbde00f26c8f0a68f94b6988069555344","7c05046c325f03e0c995c0bd256dcb5516d1edd567b83d19eb35f725018cc251f400","8db269c3ec630e06ae29f74bc39edd1f87c819f1056206e879a1cd615368656e4d6963726f555344","909133088303c49f3a30f1cc8ed553a73857a29779f6c6561cd8093fd2c8d7d47fb4046c68567e0f29bf0dce4e0a083cf4ce522ed741127dafa2ac59","f33bf12af1c23d660e29ebb0d3206b0bfc56ffd87ffafe2d36c42a454d7565736c69537761705f634c50"],"extraData":{"nftMetadata":true,"tokenMetadata":true}}' \
  --compressed


*/
